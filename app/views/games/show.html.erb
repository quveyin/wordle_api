<% content_for :title, "Wordle" %>

<div class="container">
    <h1>Wordle</h1>
    

    
    <% if flash[:alert] %>
        <div class="error-message">
            <%= flash[:alert] %>
        </div>
    <% end %>
    
    <% unless @game.completed? %>
        <div class="game-info">
            Deneme: <%= @game.guesses.count %>/6
        </div>
    <% end %>
    
    <div class="attempts">
        <% if @guesses.any? %>
            <% @guesses.each do |guess| %>
                <div class="attempt">
                    <% result = guess.feedback %>
                    <% guess.word.chars.each_with_index do |char, index| %>
                        <div class="letter <%= case result[index]
                                               when 'correct' then 'correct'
                                               when 'present' then 'present'
                                               else 'absent'
                                               end %>">
                            <%= char.upcase %>
                        </div>
                    <% end %>
                </div>
            <% end %>
        <% end %>
    </div>
    
    <% unless @game.completed? %>
        <div class="input-form">
            <%= form_with url: game_token_guess_path(@game.token), method: :post, local: true do |f| %>
                <%= f.text_field :word, 
                    maxlength: 5, 
                    placeholder: "5 harfli kelime",
                    required: true,
                    autofocus: true,
                    autocomplete: "off" %>
                <%= f.submit "Tahmin Et" %>
            <% end %>
        </div>
    <% end %>
    
    <% if @game.completed? %>
        <% if @game.won? %>
            <div class="notice">
                TEBRİKLER. Kelimeyi <%= @game.guesses.count %>. denemede buldunuz: <strong><%= @game.secret_word.upcase %></strong>
            </div>
        <% else %>
            <div class="alert">
                Deneme hakkınız tükendi. Doğru kelime: <strong><%= @game.secret_word.upcase %></strong>
            </div>
        <% end %>
        

        <div class="next-period-message">
            <% time_left = DailyWord.time_until_next_period %>
            <% hours = (time_left / 3600).floor %>
            <% minutes = ((time_left % 3600) / 60).floor %>
            <p>Yeni kelimeyle oynamak için <strong><span id="countdown-main"><%= hours %> saat <%= minutes %> dakika</span></strong> bekleyin.</p>
        </div>
    <% end %>
</div>

<div id="stats-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close">&times;</span>
    
    <h2>İstatistikler</h2>
    
    <div class="stats-container">
      <div class="stat-item">
        <div class="stat-value" id="games-played">0</div>
        <div class="stat-label">Oynanan</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="win-percentage">0%</div>
        <div class="stat-label">Kazanma %</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="current-streak">0</div>
        <div class="stat-label">Mevcut Seri</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="max-streak">0</div>
        <div class="stat-label">En Uzun Seri</div>
      </div>
    </div>
    
    <h3>Tahmin Dağılımı</h3>
    <div class="distribution">
      <% (1..6).each do |i| %>
        <div class="dist-item">
          <div class="dist-number"><%= i %></div>
          <div class="dist-bar" id="guess-distribution-<%= i %>">0</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if @game.completed? %>
<script>


function updateCountdown() {
    const now = new Date();
    const currentHour = now.getHours();
    const nextPeriodHour = Math.floor(currentHour / 10) * 10 + 10;
    
    let nextPeriod;
    if (nextPeriodHour >= 24) {
        nextPeriod = new Date(now);
        nextPeriod.setDate(nextPeriod.getDate() + 1);
        nextPeriod.setHours(0, 0, 0, 0);
    } else {
        nextPeriod = new Date(now);
        nextPeriod.setHours(nextPeriodHour, 0, 0, 0);
    }
    
    const timeDiff = nextPeriod - now;
    
    if (timeDiff <= 0) {
        location.reload();
        return;
    }
    
    const hours = Math.floor(timeDiff / (1000 * 60 * 60));
    const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
    
    const countdownText = `${hours} saat ${minutes} dakika ${seconds} saniye`;
    
    const countdownMainElement = document.getElementById('countdown-main');
    
    if (countdownMainElement) {
        countdownMainElement.textContent = countdownText;
    }
    
    const modalCountdownElement = document.getElementById('modal-countdown');
    if (modalCountdownElement) {
        const modalText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        modalCountdownElement.textContent = modalText;
    }
}

setInterval(updateCountdown, 1000);
updateCountdown();
</script>
<% end %>

<% if @game.completed? %>
<script>
async function showStatsOnGameEnd() {
  try {
    const response = await fetch('/stats');
    const stats = await response.json();
    
    document.getElementById('games-played').textContent = stats.games_played;
    document.getElementById('win-percentage').textContent = 
      stats.games_played ? Math.round((stats.games_won / stats.games_played) * 100) + '%' : '0%';
    document.getElementById('current-streak').textContent = stats.current_streak;
    document.getElementById('max-streak').textContent = stats.max_streak;
    
    for (let i = 1; i <= 6; i++) {
      const bar = document.getElementById(`guess-distribution-${i}`);
      if (bar) {
        bar.textContent = stats.guess_distribution[i] || 0;
      }
    }
    
    setTimeout(() => {
      document.getElementById('stats-modal').style.display = 'flex';
    }, 2000);
  } catch (error) {
    console.error('İstatistikler alınamadı:', error);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  showStatsOnGameEnd();
  const closeBtn = document.querySelector('.close');
  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      document.getElementById('stats-modal').style.display = 'none';
    });
  }
  
  const modal = document.getElementById('stats-modal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  }
});
</script>
<% end %>
